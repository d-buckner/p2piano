# Get the branch being pushed to
remote="$1"
url="$2"

# Read from stdin to get refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
  # Extract branch name from remote_ref (refs/heads/branch-name)
  branch=$(echo "$remote_ref" | sed 's|refs/heads/||')
  
  # Only run checks when pushing to main branch
  if [ "$branch" = "main" ]; then
    echo "🔍 Running pre-push checks for main branch..."
    
    # Run linting
    echo "📝 Running linting..."
    npm run lint
    if [ $? -ne 0 ]; then
      echo ""
      echo "❌ Linting failed!"
      echo ""
      echo "💡 To fix this:"
      echo "  1. Run 'npm run lint:fix' to auto-fix issues"
      echo "  2. Manually fix any remaining issues"
      echo "  3. Commit the fixes and try pushing again"
      echo ""
      exit 1
    fi
    
    # Run typechecking
    echo "🔍 Running type checking..."
    npm run typecheck
    if [ $? -ne 0 ]; then
      echo ""
      echo "❌ Type checking failed!"
      echo ""
      echo "💡 To fix this:"
      echo "  1. Review the TypeScript errors above"
      echo "  2. Fix the type issues in the code"
      echo "  3. Commit the fixes and try pushing again"
      echo ""
      exit 1
    fi
    
    # Check if there are any uncommitted threshold changes before testing
    threshold_changes_before=$(git status --porcelain -- client/coverage.thresholds.json service/coverage.thresholds.json)
    
    # Extract current coverage values before running tests
    client_coverage_before=$(cat client/coverage.thresholds.json | grep '"lines"' | sed 's/.*: \([0-9.]*\).*/\1/')
    service_coverage_before=$(cat service/coverage.thresholds.json | grep '"lines"' | sed 's/.*: \([0-9.]*\).*/\1/')
    
    # Stash any uncommitted changes to test only committed code
    echo "💾 Stashing uncommitted changes..."
    git stash push -u -m "pre-push-stash-$(date +%s)" || true
    
    # Run client tests and coverage
    echo "🧪 Running client tests and coverage checks..."
    cd client && npm run test:ci
    client_test_result=$?
    
    if [ $client_test_result -ne 0 ]; then
      echo ""
      echo "❌ Client tests failed!"
      echo ""
      echo "💡 To fix this:"
      echo "  1. Review the test failures above"
      echo "  2. Fix any failing tests"
      echo "  3. Commit the fixes and try pushing again"
      echo ""
      cd .. && git stash pop || true
      exit 1
    fi
    
    # Update client coverage thresholds
    npm run coverage:update
    cd ..
    
    # Run service tests and coverage
    echo "🧪 Running service tests and coverage checks..."
    cd service && npm run test:ci
    service_test_result=$?
    
    if [ $service_test_result -ne 0 ]; then
      echo ""
      echo "❌ Service tests failed!"
      echo ""
      echo "💡 To fix this:"
      echo "  1. Review the test failures above"
      echo "  2. Fix any failing tests"
      echo "  3. Commit the fixes and try pushing again"
      echo ""
      cd .. && git stash pop || true
      exit 1
    fi
    
    # Update service coverage thresholds
    npm run coverage:update
    cd ..
    
    # Restore any stashed changes first
    git stash pop || true
    
    # Extract coverage values after running tests
    client_coverage_after=$(cat client/coverage.thresholds.json | grep '"lines"' | sed 's/.*: \([0-9.]*\).*/\1/')
    service_coverage_after=$(cat service/coverage.thresholds.json | grep '"lines"' | sed 's/.*: \([0-9.]*\).*/\1/')
    
    # Display coverage comparison
    echo ""
    echo "📊 Test Coverage Summary:"
    echo "  Client:  ${client_coverage_before}% → ${client_coverage_after}%"
    echo "  Service: ${service_coverage_before}% → ${service_coverage_after}%"
    echo ""
    
    # Check if there are any threshold changes now (either from before or from test runs)
    if ! git diff --quiet -- client/coverage.thresholds.json service/coverage.thresholds.json || [ -n "$threshold_changes_before" ]; then
      echo "📊 Coverage thresholds need to be committed, amending to last commit..."
      git add client/coverage.thresholds.json service/coverage.thresholds.json
      git commit --amend --no-edit
      echo "✅ Coverage thresholds amended to last commit"
    fi
    
    echo "✅ All pre-push checks passed!"
  else
    echo "⏭️  Skipping pre-push checks for branch: $branch"
  fi
done
