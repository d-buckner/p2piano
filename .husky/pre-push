# Get the branch being pushed to
remote="$1"
url="$2"

# Read from stdin to get refs being pushed
while read local_ref local_sha remote_ref remote_sha; do
  # Extract branch name from remote_ref (refs/heads/branch-name)
  branch=$(echo "$remote_ref" | sed 's|refs/heads/||')
  
  # Only run checks when pushing to main branch
  if [ "$branch" = "main" ]; then
    echo "ğŸ” Running pre-push checks for main branch..."
    
    # Run linting
    echo "ğŸ“ Running linting..."
    npm run lint
    if [ $? -ne 0 ]; then
      echo ""
      echo "âŒ Linting failed!"
      echo ""
      echo "ğŸ’¡ To fix this:"
      echo "  1. Run 'npm run lint:fix' to auto-fix issues"
      echo "  2. Manually fix any remaining issues"
      echo "  3. Commit the fixes and try pushing again"
      echo ""
      exit 1
    fi
    
    # Run typechecking
    echo "ğŸ” Running type checking..."
    npm run typecheck
    if [ $? -ne 0 ]; then
      echo ""
      echo "âŒ Type checking failed!"
      echo ""
      echo "ğŸ’¡ To fix this:"
      echo "  1. Review the TypeScript errors above"
      echo "  2. Fix the type issues in the code"
      echo "  3. Commit the fixes and try pushing again"
      echo ""
      exit 1
    fi
    
    # Run client tests and coverage
    echo "ğŸ§ª Running client tests and coverage checks..."
    cd client && npm run test:ci && npm run coverage:update
    if [ $? -ne 0 ]; then
      echo ""
      echo "âŒ Client tests or coverage checks failed!"
      echo ""
      echo "ğŸ’¡ To fix this:"
      echo "  1. Review the test failures or coverage issues above"
      echo "  2. Fix any failing tests"
      echo "  3. If coverage dropped, either:"
      echo "     - Write more tests to improve coverage, or"
      echo "     - Run 'npm run coverage:update' to accept current levels"
      echo "  4. Commit any fixes and try pushing again"
      echo ""
      exit 1
    fi
    
    # Run service tests and coverage
    echo "ğŸ§ª Running service tests and coverage checks..."
    cd ../service && npm run test:ci && npm run coverage:update
    if [ $? -ne 0 ]; then
      echo ""
      echo "âŒ Service tests or coverage checks failed!"
      echo ""
      echo "ğŸ’¡ To fix this:"
      echo "  1. Review the test failures or coverage issues above"
      echo "  2. Fix any failing tests"
      echo "  3. If coverage dropped, either:"
      echo "     - Write more tests to improve coverage, or"
      echo "     - Run 'npm run coverage:update' to accept current levels"
      echo "  4. Commit any fixes and try pushing again"
      echo ""
      exit 1
    fi
    
    # Check if coverage thresholds were updated
    cd ..
    if ! git diff --quiet client/coverage.thresholds.json service/coverage.thresholds.json; then
      echo "ğŸ“Š Coverage thresholds were updated, amending to last commit..."
      git add client/coverage.thresholds.json service/coverage.thresholds.json
      git commit --amend --no-edit
      echo "âœ… Coverage thresholds amended to last commit"
    fi
    
    echo "âœ… All pre-push checks passed!"
  else
    echo "â­ï¸  Skipping pre-push checks for branch: $branch"
  fi
done
